"""
éƒ¨ç½²è„šæœ¬ç”Ÿæˆå™¨ Skill
==================
ç”Ÿæˆéƒ¨ç½²å’Œå›æ»šè„šæœ¬
"""

from pathlib import Path
from typing import Dict, Optional


class DeploymentScriptGenerator:
    """éƒ¨ç½²è„šæœ¬ç”Ÿæˆå™¨"""

    def __init__(self, output_dir: str = "."):
        self.output_dir = Path(output_dir)

    def generate(
        self,
        server_info: Dict,
        deploy_type: str = "docker",
        project_name: str = "app"
    ) -> Dict[str, str]:
        """
        ç”Ÿæˆéƒ¨ç½²è„šæœ¬

        Args:
            server_info: æœåŠ¡å™¨ä¿¡æ¯
            deploy_type: éƒ¨ç½²ç±»å‹ (docker/pm2/systemd)
            project_name: é¡¹ç›®åç§°

        Returns:
            ç”Ÿæˆçš„è„šæœ¬å­—å…¸
        """
        generators = {
            'docker': self._generate_docker_deploy,
            'pm2': self._generate_pm2_deploy,
            'systemd': self._generate_systemd_deploy
        }

        generator = generators.get(deploy_type, self._generate_docker_deploy)
        deploy_script, rollback_script = generator(server_info, project_name)

        return {
            'deploy': deploy_script,
            'rollback': rollback_script,
            'health_check': self._generate_health_check(server_info, project_name)
        }

    def _generate_docker_deploy(self, server: Dict, name: str) -> tuple:
        """ç”ŸæˆDockeréƒ¨ç½²è„šæœ¬"""
        host = server.get('host', 'localhost')
        user = server.get('user', 'root')
        registry = server.get('registry', 'docker.io')

        deploy = f'''#!/bin/bash
# Dockeréƒ¨ç½²è„šæœ¬
# Generated by Leo Deployment Script Generator

set -e

# é…ç½®
APP_NAME="{name}"
SERVER="{user}@{host}"
REGISTRY="{registry}"
IMAGE="$REGISTRY/$APP_NAME:${{TAG:-latest}}"

echo "ğŸš€ å¼€å§‹éƒ¨ç½² $APP_NAME"

# 1. æ„å»ºé•œåƒ
echo "ğŸ“¦ æ„å»ºDockeré•œåƒ..."
docker build -t $IMAGE .

# 2. æ¨é€é•œåƒ
echo "â¬†ï¸  æ¨é€é•œåƒåˆ°ä»“åº“..."
docker push $IMAGE

# 3. è¿œç¨‹éƒ¨ç½²
echo "ğŸ”„ è¿œç¨‹éƒ¨ç½²..."
ssh $SERVER << 'ENDSSH'
    cd /opt/$APP_NAME

    # å¤‡ä»½å½“å‰ç‰ˆæœ¬
    docker tag $IMAGE $IMAGE.backup 2>/dev/null || true

    # æ‹‰å–æ–°é•œåƒ
    docker pull $IMAGE

    # åœæ­¢æ—§å®¹å™¨
    docker-compose down

    # å¯åŠ¨æ–°å®¹å™¨
    docker-compose up -d

    # æ¸…ç†æ—§é•œåƒ
    docker image prune -f
ENDSSH

echo "âœ… éƒ¨ç½²å®Œæˆ!"
'''

        rollback = f'''#!/bin/bash
# Dockerå›æ»šè„šæœ¬
# Generated by Leo Deployment Script Generator

set -e

APP_NAME="{name}"
SERVER="{user}@{host}"
REGISTRY="{registry}"
IMAGE="$REGISTRY/$APP_NAME"

echo "âª å¼€å§‹å›æ»š $APP_NAME"

ssh $SERVER << 'ENDSSH'
    cd /opt/$APP_NAME

    # åœæ­¢å½“å‰ç‰ˆæœ¬
    docker-compose down

    # æ¢å¤å¤‡ä»½ç‰ˆæœ¬
    docker tag $IMAGE.backup $IMAGE:latest

    # å¯åŠ¨å¤‡ä»½ç‰ˆæœ¬
    docker-compose up -d
ENDSSH

echo "âœ… å›æ»šå®Œæˆ!"
'''

        return deploy, rollback

    def _generate_pm2_deploy(self, server: Dict, name: str) -> tuple:
        """ç”ŸæˆPM2éƒ¨ç½²è„šæœ¬"""
        host = server.get('host', 'localhost')
        user = server.get('user', 'root')
        path = server.get('path', f'/opt/{name}')

        deploy = f'''#!/bin/bash
# PM2éƒ¨ç½²è„šæœ¬
# Generated by Leo Deployment Script Generator

set -e

APP_NAME="{name}"
SERVER="{user}@{host}"
DEPLOY_PATH="{path}"

echo "ğŸš€ å¼€å§‹éƒ¨ç½² $APP_NAME"

# åŒæ­¥ä»£ç 
rsync -avz --exclude 'node_modules' --exclude '.git' ./ $SERVER:$DEPLOY_PATH/

# è¿œç¨‹å®‰è£…ä¾èµ–å’Œé‡å¯
ssh $SERVER << 'ENDSSH'
    cd $DEPLOY_PATH
    npm install --production
    pm2 reload ecosystem.config.js --env production
ENDSSH

echo "âœ… éƒ¨ç½²å®Œæˆ!"
'''

        rollback = f'''#!/bin/bash
# PM2å›æ»šè„šæœ¬

APP_NAME="{name}"
SERVER="{user}@{host}"

ssh $SERVER "cd {path} && git checkout HEAD~1 && pm2 reload all"

echo "âœ… å›æ»šå®Œæˆ!"
'''

        return deploy, rollback

    def _generate_systemd_deploy(self, server: Dict, name: str) -> tuple:
        """ç”ŸæˆSystemdéƒ¨ç½²è„šæœ¬"""
        host = server.get('host', 'localhost')
        user = server.get('user', 'root')

        deploy = f'''#!/bin/bash
# Systemdéƒ¨ç½²è„šæœ¬
# Generated by Leo Deployment Script Generator

set -e

APP_NAME="{name}"
SERVER="{user}@{host}"

echo "ğŸš€ å¼€å§‹éƒ¨ç½² $APP_NAME"

# åŒæ­¥ä»£ç 
rsync -avz ./ $SERVER:/opt/$APP_NAME/

# è¿œç¨‹é‡å¯æœåŠ¡
ssh $SERVER << 'ENDSSH'
    cd /opt/$APP_NAME
    pip install -r requirements.txt
    sudo systemctl restart $APP_NAME
    sudo systemctl status $APP_NAME
ENDSSH

echo "âœ… éƒ¨ç½²å®Œæˆ!"
'''

        rollback = f'''#!/bin/bash
# Systemdå›æ»šè„šæœ¬

APP_NAME="{name}"
SERVER="{user}@{host}"

ssh $SERVER "cd /opt/$APP_NAME && git checkout HEAD~1 && sudo systemctl restart $APP_NAME"

echo "âœ… å›æ»šå®Œæˆ!"
'''

        return deploy, rollback

    def _generate_health_check(self, server: Dict, name: str) -> str:
        """ç”Ÿæˆå¥åº·æ£€æŸ¥è„šæœ¬"""
        host = server.get('host', 'localhost')
        port = server.get('port', 80)
        health_path = server.get('health_path', '/health')

        return f'''#!/bin/bash
# å¥åº·æ£€æŸ¥è„šæœ¬
# Generated by Leo Deployment Script Generator

URL="http://{host}:{port}{health_path}"
MAX_RETRIES=30
RETRY_INTERVAL=2

echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."

for i in $(seq 1 $MAX_RETRIES); do
    if curl -sf $URL > /dev/null; then
        echo "âœ… æœåŠ¡å¥åº·!"
        exit 0
    fi
    echo "ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/$MAX_RETRIES)"
    sleep $RETRY_INTERVAL
done

echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥!"
exit 1
'''


def main():
    """ç¤ºä¾‹ç”¨æ³•"""
    generator = DeploymentScriptGenerator(output_dir="./output")

    results = generator.generate(
        server_info={
            'host': '192.168.1.100',
            'user': 'deploy',
            'registry': 'registry.example.com',
            'port': 8080,
            'health_path': '/api/health'
        },
        deploy_type='docker',
        project_name='my-app'
    )

    print("ç”Ÿæˆå®Œæˆï¼")
    for name in results.keys():
        print(f"  - {name}")


if __name__ == '__main__':
    main()
